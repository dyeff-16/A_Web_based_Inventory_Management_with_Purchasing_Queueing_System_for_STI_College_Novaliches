{% extends "index.html" %}
{% block content %}
<div class="container my-5">
    <h1 class="mb-4 text-primary fw-bold">Notifications</h1>

    {% if notification %}
       {% for notif in notification %}
        {% if notif.thread is defined and notif.thread %}
            {% set latest = notif.thread[-1] %}
        {% else %}
            {% set latest = {'status': notif.status if notif.status is defined else 'No Status',
                            'order_date': notif.order_date if notif.order_date is defined else '',
                            'order_time': notif.order_time if notif.order_time is defined else '',
                            'timestamp': ''} %}
        {% endif %}

        <div class="col-12 m-2">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 text-dark fw-bold">
                            Ref #: <span class="text-muted">{{ notif.reference_number }}</span>
                        </h5>
                        <p class="mb-0 text-primary fw-bold">
                            Status: {{ latest.status }}
                        </p>
                        <small class="text-muted">
                            {{ latest.order_date }} {{ latest.order_time }}
                        </small>
                    </div>

                    <button class="btn btn-link text-primary fw-bold p-0"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#notifDetails{{ loop.index }}"
                            aria-expanded="false"
                            aria-controls="notifDetails{{ loop.index }}">
                        Thread
                    </button>
                </div>

                <div class="collapse" id="notifDetails{{ loop.index }}">
                    <hr class="my-2">
                    <div class="px-3 pb-3 text-secondary">
                        {% for event in notif.thread | reverse %} {# show newest first #}
                            <div class="mb-3">
                                <p class="mb-1"><strong>Status:</strong> {{ event.status }}</p>
                                <p class="mb-1"><strong>Date:</strong> {{ event.order_date }}</p>
                                <p class="mb-1"><strong>Time:</strong> {{ event.order_time }}</p>
                                {%if event.Reason%}
                                <p class="mb-1 text-muted small">Reason: {{event.Reason}}</p>
                                {%endif%}
                                <hr class="my-2">
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info mt-4" role="alert">
            No new notifications.
        </div>
    {% endif %}
</div>
{% endblock %}
