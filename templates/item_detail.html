{% extends "index.html" %}

{% block content %}
<div class="container my-4 mt-5 bg-light p-4 rounded shadow-sm">  

<!-- ðŸ”” Flash Messages Section -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mb-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show auto-dismiss" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}


  <div class="row g-4 align-items-start">
    <div class="col-md-5 text-center">  
      <img src="data:image/jpeg;base64,{{ item.image }}" class="img-fluid rounded shadow-sm" alt="{{ item.item_name }}">
    </div>

    <div class="col-md-7">
      <h2 class="mb-3 text-primary fw-bold">{{ item.item_name }}</h2>
      <p class="text-muted"><b>Description:</b> {{ item.item_description }}</p>

      {% if item.item_category in ['Uniform', 'Proware'] and item.sizes %}
   
      <form id="itemForm" class="mb-4" method="POST" action="{{ url_for('item_details.add_to_cart') }}">
        <input type="hidden" name="item_id" value="{{ item._id }}">
        <input type="hidden" name="item_name" value="{{ item.item_name }}">
        <input type="hidden" name="item_category" value="{{ item.item_category }}">

        <div class="mb-3 w-50">
          <label for="size_selection" class="form-label">Choose Size</label> 
          <select class="form-select" name="size_selection" id="size_selection" required>
            {% for size in item.sizes %}
              {% if size.itemCode %}
              <option 
                value="{{ size.itemCode }}|{{ size.size }}|{{ size.price }}|{{ size.quantity }}"
                {% if size.quantity == 0 %}data-outofstock="true"{% endif %}>
                {{ size.size }} - ({{ size.quantity }} in stock - P{{ size.price }}.00)
              </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
        
        <div class="mb-3 d-flex align-items-center">
          <label id="label_qty" for="quantity" class="me-2">Quantity</label>
          <input type="number" name="quantity" min="1" max="10" value="1" class="form-control w-auto">    
        </div>

        <!-- Dynamic Button -->
        <button id="actionBtn" type="submit" class="btn btn-primary">Add to Cart</button>
      </form>

      {% else %}
      <!-- No Sizes (same as your code, with preorder option if out of stock) -->
      <form id="simpleForm" class="mb-4" method="POST" action="{% if item.item_quantity == 0 %}{{ url_for('item_details.preorder') }}{% else %}{{ url_for('item_details.add_to_cart') }}{% endif %}">
        
        <input type="hidden" name="item_id" value="{{ item._id }}">
        <input type="hidden" name="item_code" value="{{ item.itemCode }}">
        <input type="hidden" name="item_name" value="{{ item.item_name }}">
        <input type="hidden" name="item_category" value="{{ item.item_category }}">
        <input type="hidden" name="item_price" value="{{ item.item_price }}">

        <p class="h5 fw-bold text-primary"><strong >Price: â‚±</strong>{{ item.item_price }}.00</p>
        <p class="h5 my-3"><b>Stock:</b> {{ item.item_quantity }}</p>

        <div class="mb-3 d-flex align-items-center">
          <label class="me-2" id="label_qty" for="quantity">Quantity</label>
          <input class="form-control w-auto" type="number" name="quantity" min="1" max="10" value="1">
        </div> 

        {% if item.item_quantity == 0 %}
          <div class="alert alert-warning">Sorry, this item is out of stock!</div>
          <button type="submit" class="btn btn-dark">Pre-Order</button>
        {% else %} 
          <button type="submit" class="btn btn-primary">Add to Cart</button>
        {% endif %}
      </form>
      {% endif %}
    </div>
  </div>
</div>

<script>

  // â³ Auto-hide after 10 seconds
  setTimeout(() => {
    document.querySelectorAll('.auto-dismiss').forEach(alert => {
      let bsAlert = new bootstrap.Alert(alert);
      bsAlert.close(); // uses Bootstrap's fade-out effect
    });
  }, 10000);

  const select = document.getElementById("size_selection");
  const actionBtn = document.getElementById("actionBtn");
  const form = document.getElementById("itemForm");

  function updateButton() {
    if (!select) return;
    const selected = select.options[select.selectedIndex];
    const parts = selected.value.split("|");
    const qty = parseInt(parts[3]);

    if (qty === 0) {
      actionBtn.textContent = "Pre-Order";
      actionBtn.classList.remove("btn-primary");
      actionBtn.classList.add("btn-dark");
      form.action = "{{ url_for('item_details.preorder') }}";  // ðŸ”„ switch to preorder
    } else {
      actionBtn.textContent = "Add to Cart";
      actionBtn.classList.remove("btn-dark");
      actionBtn.classList.add("btn-primary");
      form.action = "{{ url_for('item_details.add_to_cart') }}"; // ðŸ”„ switch to add-to-cart
    }
  }

  if (select) {
    select.addEventListener("change", updateButton);
    window.addEventListener("load", updateButton);
  }
</script>
{% endblock %}
