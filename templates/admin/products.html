{% extends "admin.html" %}

{% block content %}

<div class="container-fluid mt-5 px-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
    <div class="d-flex align-items-center gap-2">
      <label for="item_category" class="form-label fw-bold me-2 mb-0">Select Category:</label>
      <select name="Category" id="item_category" class="form-select form-select-sm w-auto" onchange="toggleFields()">
        <option value="">All</option>
        <option value="Uniform">Uniform</option>
        <option value="Proware">Proware</option>
        <option value="Textbook">Textbook</option>
        <option value="RTW">RTW</option>
        <option value="WNU">WNU</option>
        <option value="SMS">SMS</option>
        <option value="MKT">MKT</option>
        <option value="ERM">ERM</option>
      </select>
    </div>

    <div class="d-flex gap-2">
      <a id="addProductBtn" href="#" class="btn btn-primary rounded-3 px-3 disabled">
        <i class="bi bi-plus-circle me-1"></i>Add Product
      </a>

      <a href="{{ url_for('item.update_items') }}" class="btn btn-outline-primary rounded-3 px-3">
        <i class="bi bi-pencil-square me-1"></i>Update Product
      </a>
    </div>
  </div>

  <input type="hidden" name="item_category" id="selected_category">
</div>

{# ---------- REUSABLE TABLE MACRO FOR SERVER-RENDERED CATEGORIES ---------- #}
{% macro render_table(table_id, title, items) %}
<div id="{{ table_id }}" class="container px-4 mb-5 category-table" style="max-width: 100%; width: 95%; display: none;">
  <div class="card border-0 shadow-sm rounded-4">
    <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between py-3">
      <h5 class="mb-0 fw-bold">{{ title }}</h5>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-dark text-center position-sticky top-0">
          <tr>
            <th>Item Code</th>
            <th>Item Name</th>
            <th>Price</th>
            <th>Category</th>
            <th>Sizes</th>
            <th>Stock</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            {% if not item.sizes %}
            <tr>
              <td>{{ item.itemCode }}</td>
              <td>{{ item.item_name }}</td>
              <td>{{ item.item_price }}</td>
              <td>{{ item.item_category }}</td>
              <td>n/a</td>
              <td>{{ item.item_quantity }}</td>
            </tr>
            {% else %}
              {% for size in item.sizes %}
              <tr>
                <td>{{ size.itemCode }}</td>
                <td>{{ item.item_name }}</td>
                <td>{{ size.price if size.price else item.item_price }}</td>
                <td>{{ item.item_category }}</td>
                <td>{{ size.size }}</td>
                <td>{{ size.quantity }}</td>
              </tr>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endmacro %}

{# ---------- "ALL ITEMS" TABLE (FILLED VIA /getproducts) ---------- #}
<div id="all_table" class="container px-4 mb-5 category-table" style="max-width: 100%; width: 95%; display: none;">
  <div class="card border-0 shadow-sm rounded-4">
    <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between py-3">
      <h5 class="mb-0 fw-bold">All Items</h5>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-dark text-center position-sticky top-0">
          <tr>
            <th>Item Code</th>
            <th>Item Name</th>
            <th>Price</th>
            <th>Category</th>
            <th>Sizes</th>
            <th>Stock</th>
          </tr>
        </thead>
        <tbody id="all_products_body">
          {# rows will be injected by JS #}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# ---------- TABLE INSTANCES (SERVER-RENDERED PER CATEGORY) ---------- #}
{{ render_table('uniform_table',  'Uniform Items',   uniforms) }}
{{ render_table('proware_table',  'Proware Items',   prowares) }}
{{ render_table('textbook_table', 'Textbook Items',  textbooks) }}
{{ render_table('rtw_table',      'RTW Items',       rtws) }}
{{ render_table('sms_table',      'SMS Items',       smss) }}
{{ render_table('wnu_table',      'WNU Items',       wnus) }}
{{ render_table('mkt_table',      'MKT Items',       mkts) }}
{{ render_table('erm_table',      'ERM Items',       erms) }}

<script>
  function toggleFields() {
    const category = document.getElementById("item_category").value;
    const selectedCategoryInput = document.getElementById("selected_category");

    const tables = {
      "Uniform": "uniform_table",
      "Proware": "proware_table",
      "Textbook": "textbook_table",
      "RTW": "rtw_table",
      "SMS": "sms_table",
      "WNU": "wnu_table",
      "MKT": "mkt_table",
      "ERM": "erm_table"
    };

    // Hide all tables (including "All")
    document.querySelectorAll(".category-table").forEach(el => {
      el.style.display = "none";
    });

    // If "All" is selected (empty value)
    if (category === "") {
      document.getElementById("all_table").style.display = "block";
      loadAllProducts();
    } else if (tables[category]) {
      // Show only the selected category's table
      const table = document.getElementById(tables[category]);
      if (table) table.style.display = "block";
    }

    // Update hidden input
    selectedCategoryInput.value = category;

    // Update Add Product button link + disabled state
    const addBtn = document.getElementById("addProductBtn");
    if (category === "Uniform") {
      addBtn.href = "{{ url_for('item.add_uniform') }}";
    } else if (category === "Proware") {
      addBtn.href = "{{ url_for('item.add_proware') }}";
    } else if (category === "Textbook") {
      addBtn.href = "{{ url_for('item.add_textbook') }}";
    } else if (category === "SMS") {
      addBtn.href = "{{ url_for('item.add_sms') }}";
    } else if (category === "MKT") {
      addBtn.href = "{{ url_for('item.add_mkt') }}";
    } else if (category === "ERM") {
      addBtn.href = "{{ url_for('item.add_erm') }}";
    } else if (category === "RTW") {
      addBtn.href = "{{ url_for('item.add_rtw') }}";
    } else if (category === "WNU") {
      addBtn.href = "{{ url_for('item.add_wnu') }}";
    } else {
      addBtn.href = "#";
    }

    if (category) {
      addBtn.classList.remove("disabled");
    } else {
      addBtn.classList.add("disabled");
    }
  }

  function loadAllProducts() {
    const tbody = document.getElementById("all_products_body");
    // Optional: clear old rows before filling
    tbody.innerHTML = "";

    fetch("{{ url_for('item.getproducts') }}")
      .then(response => response.json())
      .then(data => {
        if (!data.items) return;

        data.items.forEach(item => {
          // No sizes
          if (!item.sizes || item.sizes.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${item.itemCode || ""}</td>
              <td>${item.item_name || ""}</td>
              <td>${item.item_price || ""}</td>
              <td>${item.item_category || ""}</td>
              <td>N/A</td>
              <td>${item.item_quantity || ""}</td>
            `;
            tbody.appendChild(tr);
          } else {
            // With sizes
            item.sizes.forEach(size => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td class='text-center'>${size.itemCode || ""}</td>
                <td class='text-center'>${item.item_name || ""}</td>
                <td class='text-center'>${(size.price !== null && size.price !== undefined && size.price !== "") ? size.price : (item.item_price || "")}</td>
                <td class='text-center'>${item.item_category || ""}</td>
                <td class='text-center'>${size.size || ""}</td>
                <td class='text-center'>${size.quantity || ""}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        });
      })
      .catch(err => {
        console.error("Error loading products:", err);
      });
  }

  // On first load: default to "All"
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("item_category").value = "";
    toggleFields();
  });
</script>

{% endblock %}
