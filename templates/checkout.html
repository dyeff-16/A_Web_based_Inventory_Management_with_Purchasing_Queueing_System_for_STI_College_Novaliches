<style>
    .card {
        transition: transform 0.2s ease-in-out, background-color 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        background-color: #f0f8ff;
    }

    .card img {
        transition: transform 0.3s ease;
    }

    .card:hover img {
        transform: scale(1.05);
    }

    .total-summary {
        color: #0d6efd;
        border-radius: 10px;
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        transition: background-color 0.3s;
    }

    .modal-content {
        border-radius: 15px;
    }

    .img-thumbnail {
        border-radius: 10px;
    }
</style>

{% extends "index.html" %}
{% block content %}
<div class="container my-5">
    <h1 class="mb-4 text-primary fw-bold">
        <i class="bi bi-cart-check me-2"></i>Checkout Summary
    </h1>

    {% if items %}
    <div class="row g-4">
        {% for item in items %}
        <div class="col-12">
            <div class="card shadow-sm border-shadow">
                <div class="card-body d-flex align-items-center flex-wrap bg-light rounded">
                    <img src="data:image/jpeg;base64,{{ item.image }}" class="img-thumbnail me-3"
                        alt="{{ item.item_name }}" style="width: 150px; height: 200px; object-fit: cover;">

                    <div class="flex-grow-1">
                        <h3 class="card-title mb-2 text-dark fw-bold">{{ item.item_name }}</h3>
                        <p class="mb-1 text-primary fw-bold fs-5">Price: â‚± {{ item.item_price }}.00</p>
                        {% if item.size %}
                        <p class="mb-1"><strong>Size:</strong> {{ item.size }}</p>
                        {% endif %}
                        <p class="mb-1"><strong>Quantity:</strong> {{ item.item_quantity }}</p>
                        <p class="mb-1 text-success fw-bold fs-5">
                            <strong>Total:</strong> â‚± {{ item.total_amount }}.00
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- TERMS & CONDITIONS SECTION â€“ only show if NOT yet read -->

        <div class="col-12">
            <div class="mt-3 mb-5 p-3 border-0 border-light rounded border shadow-sm">
                {% if not has_read_terms %}<div>
                    <!-- Checkbox starts DISABLED for first-time user -->
                    <input class="form-check-input" type="checkbox" id="termscondition" disabled>
                    <label class="form-check-label mb-3 ms-1 text-dark fw-semibold" for="termscondition">
                        I agree to the
                        <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal"
                            class="text-primary text-decoration-underline">Terms & Conditions</a>
                    </label>

                    <!-- TERMS MODAL -->
                    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title fw-bold text-primary" id="termsModalLabel">
                                        A Web-based Inventory Management with Purchasing Queueing System for
                                        STI College Novaliches
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                                    <!-- your existing T&C text -->
                                                              <h5 class="fw-bold">Data Privacy </h5> 
                            <p>The Data Privacy Statement explains how A Web-based Inventory Management with Purchasing Queueing System for STI 
                                College Novaliches in the collection, usage, storage, and protection of the users' personal information. Users 
                                by accessing or using the System automatically agree to the Terms and Conditions and give their consent to the 
                                gathering and processing of their data according to Republic Act No. 10173, which is better known as the Data Privacy Act 
                                of 2012.            
                            </p>
                            <h6 class="fw fw-semibold mt-4">1. Data Collection</h6>
                                <ul>
                                    <li>STI Outlook Email</li>
                                    <li>Login Credentials for Authentication </li>
                                    <li>Proof of payment when uploading image for validation of transaction</li>
                                    <li>Order history and transaction records </li>
                                </ul>
                                <p>Only information necessary for the operation and maintenance of the system shall be collected.</p>
                            
                            <h6 class="fw fw-semibold mt-4">2. Purpose of Data Processing</h6>
                            <p>The collected data shall be used for the following purposes such as:</p>
                            <ul>
                                <li>To verify and authenticate user identity through Multi-Factor Authenticator</li>
                                <li>To process, manage, and record user transactions and pre orders.</li>
                                <li>To ensure accurate and secure transactions between user and the system.</li>
                            </ul>
                            <h6 class="fw fw-semibold mt-4">3. Data Protection and Security</h6>
                            <ul>
                                <li>Multi-Factor Authentication to secure user access.</li>
                                <li>Regular system monitoring and backup procedures</li>
                            </ul>
                            <h6 class="fw fw-semibold mt-4">4. Data Sharing and Disclosure</h6>
                            <ul>
                                <li>Personal Information will not be shared, sold, or disclosed to third parties.</li>
                            </ul>
                            <h6 class="fw fw-semibold mt-4">5. Consent</h6>
                            <p>The System is being used by the users to confirm that they have read, comprehended, 
                                and accepted these Terms and Conditions for Data Privacy and at the same time, they
                                give consent to the collection and use of their personal data in the manner described.
                            </p>
                            
                            <h5 class="fw-bold">Terms and Condition</h5> 
                            <h6 class="fw-semibold mt-4">1. Acceptance of Terms</h6> 
                           <p> By accessing or using the Web-based Inventory Management with Purchasing Queueing System, you agree to comply with these Terms 
                            and Conditions. </p> 
                            <h6 class="fw-semibold mt-4">2. Eligibility </h6>
                             <ul> 
                                <li>The System is intended primarily for currently enrolled students and staff of STI College Novaliches.</li> 
                                <li>Alumni and guests may browse available merchandise but cannot place direct orders.</li> 
                            </ul> 
                            <h6 class="fw-semibold mt-4">3. Use of the System</h6> 
                            <ul> 
                                <li>Every user should login with their official account with a Multi-Factor Authenticator.</li> 
                                <li>Each user is responsible for maintaining the confidentiality of their account credentials.</li> 
                                <li>Any activity contrary to these terms, including misuse, unauthorized access, or fraud, is strictly prohibited.</li> 
                            </ul> 
                            <h6 class="fw-semibold mt-4">4. Ordering and Queueing</h6> 
                            <ul> 
                                <li>Orders and pre-orders for items will be filled out on a first-come, first-served basis.</li> 
                                <li>The availability of pre-ordered items still depends on stock.</li> 
                            </ul> 
                            <h6 class="fw-semibold mt-4">5. Payments and Verification </h6> 
                            <ul> 
                                <li>Payments must be made only through the official cashier of STI College Novaliches.</li> 
                                <li>Orders will only be processed after successful payment verification.</li> 
                            </ul> 
                            <h6 class="fw-semibold mt-4">5. Payments and Verification </h6> 
                            <ul> 
                                <li>Payments must be made only through the official cashier of STI College Novaliches.</li> 
                                <li>Orders will only be processed after successful payment verification.</li> 
                            </ul> 
                            <h6 class="fw-semibold mt-4">6. Inventory and Availability</h6> 
                            <ul> 
                                <li>The System provides real-time inventory updates. However, availability is not guaranteed until payment is verified.</li> 
                            </ul> 
                            <h6 class="fw-semibold mt-4">7. Security</h6> 
                            <ul> 
                                <li>The system secures accounts using multi-factor authentication.</li> 
                                <li>The school is not responsible for breaches that arise from user negligence, such as password sharing.</li> 
                            </ul> 
                            <h6 class="fw-semibold mt-4">8. Responsibilities of Users</h6> 
                            <p>Users agree to:</p> 
                               <ul> 
                                    <li>Provide accurate information when placing orders and uploading proof of payment.</li> 
                                    <li>Use the System solely for legitimate transactions.</li> 
                                    <li>Respect queueing protocols and avoid attempts to bypass or manipulate the process.</li> 
                                </ul> 
                            <h6 class="fw-semibold mt-4">9. Limitations of Liability</h6> 
                            <ul> 
                                <li> STI College Novaliches is not liable for losses resulting from: 
                                    <ul> 
                                        <li>Unauthorized use of user accounts.</li> 
                                        <li>Errors in uploaded payment proofs or user-provided information.</li> 
                                    </ul> 
                                </li> 
                            </ul> 
                            <h6 class="fw-semibold mt-4">10. Modification and Termination</h6> 
                            <p>The school also reserves the right to suspend or revoke access to the System in cases of 
                                repeated uploading of unnecessary or invalid proof of payment. </p>
                                    <button type="button" class="btn btn-primary" id="accept-terms"
                                        data-bs-dismiss="modal">
                                        I Have Read
                                    </button>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END TERMS MODAL -->
                </div>
                {% endif %}
                <div>
                    <h3 class="fw-bold text-start mb-0">
                        <i class="bi bi-cash-stack me-2"></i>Total Amount: â‚± {{ total }}0
                    </h3>
                </div>
            </div>
        </div>


        <!-- CHECKOUT FORM -->
        <div class="col-12 text-end">
            <form id="checkoutForm" action="{{ url_for('checkout.place_order') }}" method="POST">
                {% for item in items %}
                <input type="hidden" name="selected_items" value="{{ item.itemCode }}">
                {% endfor %}
                <!-- Confirm Order button:
                     ðŸ”¹ disabled only if terms NOT yet read -->
                <button type="button" class="btn btn-primary mt-3 px-4 px-5 py-2 fw-bold" id="btnConfirmOrder"
                    data-bs-toggle="modal" data-bs-target="#confirmationModal" {% if not has_read_terms %}disabled{%
                    endif %}>
                    <i class="bi bi-check-circle me-2"></i>Confirm Order
                </button>
            </form>
        </div>

        <!-- CONFIRMATION MODAL -->
        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-primary shadow" style="max-height: 275px;">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold text-primary" id="confirmationModalLabel">
                            <i class="bi bi-exclamation-triangle me-2"></i>Confirm Order
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p>Are you sure you want to place this order?</p>
                        <p class="text-muted">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>No</button>
                        <button type="button" class="btn btn-success" onclick="confirmOrder()">
                            <i class="bi bi-check-circle me-1"></i>Yes</button>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center mt-3">
            <p>No items selected for checkout.</p>
        </div>
        {% endif %}
    </div>

    <script>
        // Confirm the order and submit the form
        function confirmOrder() {
            const termsCheckbox = document.getElementById('termscondition');
            const checkoutForm = document.getElementById('checkoutForm');

            if (!checkoutForm) return;

            // If T&C checkbox exists (first time), enforce it
            if (termsCheckbox && !termsCheckbox.checked) {
                alert('Please read and agree to the Terms & Conditions before checking out.');
                return;
            }

            // If no checkbox (already accepted) or it's checked, submit
            checkoutForm.submit();
        }

        document.addEventListener('DOMContentLoaded', function () {
            const termsCheckbox = document.getElementById('termscondition'); // may be null if already accepted
            const acceptBtn = document.getElementById('accept-terms');       // may be null if already accepted
            const confirmBtn = document.getElementById('btnConfirmOrder');
            const checkoutForm = document.getElementById('checkoutForm');

            if (!confirmBtn || !checkoutForm) return;

            // If T&C is NOT rendered (user already accepted), do nothing
            if (!termsCheckbox || !acceptBtn) {
                return;
            }

            // First-time: initial state
            termsCheckbox.disabled = true;
            confirmBtn.disabled = true;

            // When "I Have Read" is clicked
            acceptBtn.addEventListener('click', function () {
                termsCheckbox.disabled = false;
                termsCheckbox.required = true;
                termsCheckbox.checked = true;

                // Enable Confirm Order
                confirmBtn.disabled = false;

                // ðŸ”¹ Send JSON to backend (NO CSRF)
                fetch('/check_out/hasRead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ hasRead: true })
                })
                    .then(r => r.json())
                    .then(data => console.log('Saved terms status:', data))
                    .catch(err => console.error('Error saving terms:', err));
            });

            // If user unchecks the box
            termsCheckbox.addEventListener('change', function () {
                confirmBtn.disabled = !termsCheckbox.checked;
            });

            // Final safety (in case of direct form submission)
            checkoutForm.addEventListener('submit', function (e) {
                if (termsCheckbox && !termsCheckbox.checked) {
                    e.preventDefault();
                    alert('Please read and agree to the Terms & Conditions before checking out.');
                }
            });
        });

    </script>
    {% endblock %}